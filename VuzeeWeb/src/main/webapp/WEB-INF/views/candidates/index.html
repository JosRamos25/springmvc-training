<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="layout/main">
<head>
<title>Candidates</title>
</head>
<body>


	<div layout:fragment="content">
		<th:block th:if="${message}">
			<div class="alert alert-success alert-dismissable fade in">
				<a href="#" class="close" data-dismiss="alert" aria-label="cerrar">&times;</a>
				<strong th:text="${message}"></strong>
			</div>
		</th:block>

		<section class="content-header">
			<h1>Candidatos</h1>
			<ol class="breadcrumb">
				<li><a th:href="@{/}"><i class="fa fa-dashboard"></i> Home</a></li>
				<li class="active">Candidatos</li>
			</ol>
		</section>

		<div class="box">
			<div class="box-header">
				<h3 class="box-title">Listado</h3>
				<a class="btn btn-default pull-right"
					th:href="@{/candidates/create}"> <i
					class="ios-add-circle-outline"></i> Nuevo
				</a>
			</div>
			<!-- /.box-header -->
			<div class="box-body">
				<table id="data-table" class="table table-bordered table-striped">
					<thead>
						<tr>
							<th>Id</th>
							<th>Nombre</th>
							<th>Aplica para</th>
							<th>Fecha Alta</th>
							<!-- <th>CV</th>
							<th>Editar</th>
							<th>Eliminar</th> -->
						</tr>
					</thead>
					<tbody>

						<!-- <tr th:each="candidate : ${candidates}"
							th:id="'candidate' + ${candidate.id}">
							<td th:text="${candidate.id}"></td>
							<td th:text="${candidate.name}"></td>
							<td th:text="${candidate.positionApplied}"></td>
							<td
								th:text="${#dates.format(candidate.createdAt, 'dd-MMM-yyyy HH:ss')}">Agregado
								el</td>
							<td><th:block th:if="${candidate.cv}">
									<a th:href="@{/candidates/downloadcv/__${candidate.id}__}"
										target="_blank">Descargar <span
										class="glyphicon glyphicon-cloud-download"></span></a>
								</th:block> <th:block th:unless="${candidate.cv}">
									<form method="POST" enctype="multipart/form-data"
										action="candidates/uploadcv" th:id="'form' + ${candidate.id}">
										<input type="hidden" name="id" th:value="${candidate.id}" />
										<input type="file" name="file" /> <a href="#"
											th:onclick="'submitForm(' + ${candidate.id} + ');'">
											Subir <span class="glyphicon glyphicon-cloud-upload"></span>
										</a>
									</form>
								</th:block></td>
							<td><a th:href="@{/candidates/edit/__${candidate.id}__}"><span
									class="glyphicon glyphicon-edit" aria-hidden="true"></span></a></td>
							<td><a href="#"
								th:onclick="'deleteCandidate(' + ${candidate.id} + ');'"><span
									class="glyphicon glyphicon-trash" aria-hidden="true"></span></a></td>
						</tr> -->
					</tbody>
				</table>
			</div>
			<!-- /.box-body -->
		</div>
	</div>
	<th:block layout:fragment="scripts">
		<link rel="stylesheet"
			th:href="@{/resources/datatables.net-bs/css/dataTables.bootstrap.css}" />
		<!-- DataTables -->
		<script th:src="@{/resources/datatables.net/js/jquery.dataTables.js}"></script>
		<script
			th:src="@{/resources/datatables.net-bs/js/dataTables.bootstrap.js}"></script>
		<!-- SlimScroll -->
		<script
			th:src="@{/resources/jquery-slimscroll/jquery.slimscroll.min.js}"></script>
		<!-- FastClick -->
		<script th:src="@{/resources/fastclick/lib/fastclick.js}"></script>
		<!-- SweetAlert2 -->
		<script th:src="@{/resources/sweetalert2/dist/sweetalert2.all.min.js}"></script>

		<script type="text/javascript">
			function deleteCandidate(id) {
				swal({
					title : 'Esta seguro?',
					text : "Esta acción no se podra deshacer!",
					type : 'warning',
					showCancelButton : true,
					confirmButtonColor : '#3085d6',
					cancelButtonColor : '#d33',
					confirmButtonText : 'Si, Eliminalo!'
				})
						.then(
								function() {
									$
											.ajax({
												type : "DELETE",
												url : "candidates/delete/" + id,
												success : function(response) {
													$('#data-table')
															.DataTable()
															.row(
																	$("#candidate"
																			+ id))
															.remove().draw();
													swal(
															'Eliminad!',
															'Se ha eliminado al candidato.',
															'success')
												},
												error : function(xhr,
														ajaxOptions,
														thrownError) {
													console
															.log(xhr.responseText);
												}
											});

								});

			}
			function submitForm(id) {
				$("#form" + id).submit();
			}
			
			$.fn.dataTable.pipeline = function ( opts ) {
			    // Configuration options
			    var conf = $.extend( {
			        pages: 5,     // number of pages to cache
			        url: '',      // script url
			        data: null,   // function or object with parameters to send to the server
			                      // matching how `ajax.data` works in DataTables
			        method: 'GET' // Ajax HTTP method
			    }, opts );
			 
			    // Private variables for storing the cache
			    var cacheLower = -1;
			    var cacheUpper = null;
			    var cacheLastRequest = null;
			    var cacheLastJson = null;
			 
			    return function ( request, drawCallback, settings ) {
			        var ajax          = false;
			        var requestStart  = request.start;
			        var drawStart     = request.start;
			        var requestLength = request.length;
			        var requestEnd    = requestStart + requestLength;
			         
			        if ( settings.clearCache ) {
			            // API requested that the cache be cleared
			            ajax = true;
			            settings.clearCache = false;
			        }
			        else if ( cacheLower < 0 || requestStart < cacheLower || requestEnd > cacheUpper ) {
			            // outside cached data - need to make a request
			            ajax = true;
			        }
			        else if ( JSON.stringify( request.order )   !== JSON.stringify( cacheLastRequest.order ) ||
			                  JSON.stringify( request.columns ) !== JSON.stringify( cacheLastRequest.columns ) ||
			                  JSON.stringify( request.search )  !== JSON.stringify( cacheLastRequest.search )
			        ) {
			            // properties changed (ordering, columns, searching)
			            ajax = true;
			        }
			         
			        // Store the request for checking next time around
			        cacheLastRequest = $.extend( true, {}, request );
			 
			        if ( ajax ) {
			            // Need data from the server
			            if ( requestStart < cacheLower ) {
			                requestStart = requestStart - (requestLength*(conf.pages-1));
			 
			                if ( requestStart < 0 ) {
			                    requestStart = 0;
			                }
			            }
			             
			            cacheLower = requestStart;
			            cacheUpper = requestStart + (requestLength * conf.pages);
			 
			            request.start = requestStart;
			            request.length = requestLength*conf.pages;
			            request.numPage = requestStart/requestLength;
			 
			            // Provide the same `data` options as DataTables.
			            if ( $.isFunction ( conf.data ) ) {
			                // As a function it is executed with the data object as an arg
			                // for manipulation. If an object is returned, it is used as the
			                // data object to submit
			                var d = conf.data( request );
			                if ( d ) {
			                    $.extend( request, d );
			                }
			            }
			            else if ( $.isPlainObject( conf.data ) ) {
			                // As an object, the data given extends the default
			                $.extend( request, conf.data );
			            }
			 
			            settings.jqXHR = $.ajax( {
			                "type":     conf.method,
			                "url":      conf.url,
			                "data":     request,
			                "dataType": "json",
			                "cache":    false,
			                "success":  function ( json ) {
			                	json.data = json.data.map(function(a){
	                    			return Object.values(a);
		                    		});
			                    cacheLastJson = $.extend(true, {}, json);
			 					console.log(json);
			                    if ( cacheLower != drawStart ) {
			                        json.data.splice( 0, drawStart-cacheLower );
			                    }
			                    if ( requestLength >= -1 ) {
			                        json.data.splice( requestLength, json.data.length );
			                    }
			                    drawCallback( json );
			                }
			            } );
			        }
			        else {
			            json = $.extend( true, {}, cacheLastJson );
			            json.draw = request.draw; // Update the echo for each response
			            json.data.splice( 0, requestStart-cacheLower );
			            json.data.splice( requestLength, json.data.length );
			 
			            drawCallback(json);
			        }
			    }
			}
			 
			// Register an API method that will empty the pipelined data, forcing an Ajax
			// fetch on the next draw (i.e. `table.clearPipeline().draw()`)
			$.fn.dataTable.Api.register( 'clearPipeline()', function () {
			    return this.iterator( 'table', function ( settings ) {
			        settings.clearCache = true;
			    } );
			} );
			 
			 
			//
			// DataTables initialisation
			//
			$(document).ready(function() {
			    $('#data-table').DataTable( {
			        "processing": true,
			        "serverSide": true,
			        lengthMenu : [ [ 3, 10, 25, -1 ],
						[ 3, 10, 25, "All" ] ],
			        "ajax": $.fn.dataTable.pipeline( {
			            url: 'candidates/page',
			            pages: 1 // number of pages to cache
			        } )
			    } );
			} );
			
			/* $(function() {
				$('#data-table')
						.DataTable(
								{
									paging : true,
									lengthMenu : [ [ 3, 10, 25, -1 ],
											[ 3, 10, 25, "All" ] ],
									language : {
										search : "Buscar",
										lengthMenu : "Mostrar _MENU_ entradas",
										info : "Mostrando ( _START_ - _END_ ) de _TOTAL_ elementos",
										paginate : {
											first : "Primero",
											previous : "Anterior",
											next : "Siguiente",
											last : "Último"
										}
									}
								}); 
			});*/
		</script>
	</th:block>
</body>
</html>